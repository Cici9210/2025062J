"""
架構圖文件 (architecture.md)
功能: 提供系統詳細架構說明
"""
# 壓感互動裝置 - 系統架構文件

## 系統架構概覽

壓感互動裝置系統是一個多層架構的系統，通過網絡連接，實現實體壓感互動和數位視覺反饋的整合。

### 架構圖

```
+----------------+     HTTP/WS     +----------------+     HTTP/WS     +----------------+
|                |<--------------->|                |<--------------->|                |
|  Flutter App   |                 |  FastAPI Server|                 |  ESP32 Device  |
|                |                 |                |                 |                |
+----------------+                 +----------------+                 +----------------+
     |                                     |
     |                                     |
     v                                     v
+----------------+                 +----------------+
|                |                 |                |
|   UI Rendering |                 |  MySQL Database|
|   State Mgmt   |                 |                |
+----------------+                 +----------------+
```

## 技術棧詳解

### 1. 前端 (Flutter)

- **框架**: Flutter 2.0+
- **狀態管理**: Provider
- **網絡**: HTTP (RESTful API) + WebSocket (即時通訊)
- **主要模塊**:
  - 認證模塊
  - 裝置綁定模塊
  - 心臟互動模塊
  - 配對機制模塊
  - 視覺效果模塊

### 2. 後端 (FastAPI)

- **框架**: FastAPI
- **ORM**: SQLAlchemy
- **認證**: JWT (JSON Web Tokens)
- **即時通訊**: WebSockets
- **API文檔**: Swagger UI (自動生成)
- **主要模塊**:
  - 用戶管理
  - 裝置管理
  - 互動記錄
  - 配對管理
  - WebSocket 連接管理

### 3. 資料庫 (MySQL)

- **版本**: MySQL 8.0
- **主要表格**:
  - users (用戶資料)
  - devices (裝置資訊)
  - interactions (互動記錄)
  - heartbeat_logs (心跳日誌)
  - pairings (配對關係)
  - friendships (好友關係)

### 4. 硬體 (ESP32)

- **微控制器**: ESP32
- **連接**: WiFi + WebSocket
- **感測器**: 壓力感測器
- **輸出**: RGB LED + 加熱元件
- **主要模塊**:
  - 網絡連接模塊
  - 感測器讀取模塊
  - LED控制模塊
  - 加熱控制模塊

## 資料流程

### 1. 使用者註冊/登入流程

1. 使用者在Flutter應用輸入註冊資訊
2. 應用通過HTTP請求發送到後端
3. 後端驗證資訊，創建用戶，返回JWT令牌
4. 應用存儲令牌並跳轉到主頁面

### 2. 裝置綁定流程

1. 使用者在應用中輸入裝置ID
2. 應用發送綁定請求到後端
3. 後端更新數據庫，關聯裝置與用戶
4. 應用顯示綁定成功

### 3. 心臟互動流程

1. ESP32讀取壓力感測器數據
2. 數據通過WebSocket發送到後端
3. 後端記錄互動並轉發數據
4. 如有配對，則轉發數據到配對的用戶/裝置
5. 應用和ESP32接收數據並更新視覺/實體反饋

### 4. 配對流程

1. 使用者請求隨機配對
2. 後端選擇一個可用用戶並創建配對關係
3. 後端更新WebSocket連接管理器的配對映射
4. 配對雙方開始接收對方的心臟互動數據

## 安全性考量

1. **認證**: 使用JWT進行API認證
2. **數據傳輸**: 可考慮使用HTTPS/WSS加密
3. **密碼存儲**: 使用bcrypt雜湊
4. **輸入驗證**: 前後端均進行資料驗證

## 擴展性設計

1. **模塊化架構**: 各功能模塊獨立，便於擴展
2. **API版本控制**: 可考慮添加API版本前綴
3. **容器化部署**: 可使用Docker包裝各服務
4. **負載均衡**: 可引入多實例部署
