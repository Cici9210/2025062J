# API ç«¯é»é·ç§»æŒ‡å—

## ğŸ“Œ é‡è¦æ›´æ–°èªªæ˜

ç”±æ–¼é…å°å’Œå¥½å‹åŠŸèƒ½çš„é‡æ§‹,éƒ¨åˆ† API ç«¯é»å·²ç¶“æ›´æ–°ã€‚è«‹ä½¿ç”¨æ–°çš„ç«¯é»ä»¥ç²å¾—å®Œæ•´åŠŸèƒ½ã€‚

---

## ğŸ”„ ç«¯é»å°æ‡‰è¡¨

### é…å°ç›¸é—œ

| èˆŠç«¯é» (å·²å»¢æ£„) | æ–°ç«¯é» | èªªæ˜ |
|----------------|--------|------|
| `POST /api/pairing/request` | `POST /api/pairing/match` | å‰µå»ºé…å° (è‡ªå‹•å‰µå»ºè‡¨æ™‚èŠå¤©å®¤) |
| `POST /api/pairing/random` | *(æš«ç„¡)* | éš¨æ©Ÿé…å° (å¾…å¯¦ç¾) |

**æ–°ç«¯é»é¡å¤–åŠŸèƒ½:**
- é…å°æˆåŠŸå¾Œè‡ªå‹•å‰µå»º 30 ç§’è‡¨æ™‚èŠå¤©å®¤
- è¿”å›é…å° ID å’Œç‹€æ…‹

### å¥½å‹ç›¸é—œ

| èˆŠç«¯é» (å·²å»¢æ£„) | æ–°ç«¯é» | èªªæ˜ |
|----------------|--------|------|
| `GET /api/friends` | `GET /api/pairing/friends` | ç²å–å¥½å‹åˆ—è¡¨ |
| `GET /api/friends/requests/pending` | `GET /api/pairing/invitations` | ç²å–å¾…è™•ç†çš„å¥½å‹é‚€è«‹ |
| `POST /api/friends/request` | *(è‡ªå‹•è§¸ç™¼)* | è‡¨æ™‚èŠå¤©å®¤éæœŸå¾Œè‡ªå‹•å‰µå»ºé‚€è«‹ |
| `POST /api/friends/request/{id}/accept` | `POST /api/pairing/invitations/{id}/respond` | å›æ‡‰å¥½å‹é‚€è«‹ |
| `POST /api/friends/request/{id}/reject` | `POST /api/pairing/invitations/{id}/respond` | å›æ‡‰å¥½å‹é‚€è«‹ |
| `DELETE /api/friends/{id}` | *(å¾…å¯¦ç¾)* | ç§»é™¤å¥½å‹ |

**æ–°ç«¯é»é¡å¤–åŠŸèƒ½:**
- åŒ…å«åœ¨ç·šç‹€æ…‹ (is_online)
- åŒ…å«å¥½å‹é‚€è«‹éæœŸæ™‚é–“
- é›™æ–¹æ¥å—å¾Œè‡ªå‹•å‡ç´šèŠå¤©å®¤ç‚ºæ°¸ä¹…

### èŠå¤©å®¤ç›¸é—œ (æ–°å¢)

| ç«¯é» | èªªæ˜ |
|------|------|
| `GET /api/pairing/chat-rooms` | ç²å–æˆ‘çš„æ‰€æœ‰èŠå¤©å®¤ (è‡¨æ™‚+æ°¸ä¹…) |
| `GET /api/pairing/chat-room/{user_id}` | ç²å–èˆ‡ç‰¹å®šç”¨æˆ¶çš„èŠå¤©å®¤ |
| `POST /api/pairing/chat-room/{id}/check-expiry` | æª¢æŸ¥èŠå¤©å®¤æ˜¯å¦éæœŸä¸¦è§¸ç™¼é‚€è«‹ |

---

## ğŸ“‹ æ–°çš„å·¥ä½œæµç¨‹

### 1. é…å°æµç¨‹

```
å‰µå»ºé…å° â†’ è‡ªå‹•å‰µå»ºè‡¨æ™‚èŠå¤©å®¤ (30ç§’) â†’ èŠå¤©äº’å‹•
```

**API èª¿ç”¨:**
```http
POST /api/pairing/match
{
  "target_user_id": 2
}
```

**è¿”å›:**
```json
{
  "id": 1,
  "user_id_1": 1,
  "user_id_2": 2,
  "status": "active",
  "created_at": "2025-10-08T10:00:00",
  "matched_at": "2025-10-08T10:00:00"
}
```

### 2. èŠå¤©å®¤æŸ¥è©¢

```http
GET /api/pairing/chat-rooms
```

**è¿”å›:**
```json
[
  {
    "id": 1,
    "room_type": "temporary",
    "is_active": true,
    "expires_at": "2025-10-08T10:00:30",
    "created_at": "2025-10-08T10:00:00",
    "other_user_id": 2,
    "other_user_email": "user2@example.com",
    "is_friend": false
  }
]
```

### 3. å¥½å‹é‚€è«‹æµç¨‹

**ç­‰å¾… 30 ç§’å¾Œæª¢æŸ¥éæœŸ:**
```http
POST /api/pairing/chat-room/1/check-expiry
```

**è¿”å›:**
```json
{
  "expired": true,
  "invitation_created": true,
  "invitation_id": 1
}
```

**æŸ¥è©¢å¥½å‹é‚€è«‹:**
```http
GET /api/pairing/invitations
```

**è¿”å›:**
```json
[
  {
    "id": 1,
    "chat_room_id": 1,
    "other_user_id": 2,
    "other_user_email": "user2@example.com",
    "my_response": null,
    "other_response": null,
    "status": "pending",
    "created_at": "2025-10-08T10:00:30",
    "expires_at": "2025-10-09T10:00:30",
    "time_remaining": 86400
  }
]
```

**æ¥å—é‚€è«‹:**
```http
POST /api/pairing/invitations/1/respond
{
  "response": "accept"
}
```

**é›™æ–¹éƒ½æ¥å—å¾Œè¿”å›:**
```json
{
  "success": true,
  "became_friends": true,
  "friendship_id": 1,
  "message": "é›™æ–¹éƒ½æ¥å—é‚€è«‹,å·²æˆç‚ºå¥½å‹!"
}
```

### 4. æŸ¥è©¢å¥½å‹åˆ—è¡¨

```http
GET /api/pairing/friends
```

**è¿”å›:**
```json
[
  {
    "user_id": 2,
    "email": "user2@example.com",
    "is_online": false,
    "last_seen": null
  }
]
```

---

## âš ï¸ é‡è¦è®Šæ›´

### 1. å¥½å‹é‚€è«‹è‡ªå‹•è§¸ç™¼
- **èˆŠç‰ˆ:** æ‰‹å‹•å‰µå»ºå¥½å‹è«‹æ±‚
- **æ–°ç‰ˆ:** è‡¨æ™‚èŠå¤©å®¤éæœŸå¾Œè‡ªå‹•å‰µå»ºå¥½å‹é‚€è«‹

### 2. é›™æ–¹ç¢ºèªåˆ¶
- **èˆŠç‰ˆ:** ä¸€æ–¹ç™¼é€è«‹æ±‚,å¦ä¸€æ–¹æ¥å—/æ‹’çµ•
- **æ–°ç‰ˆ:** é›™æ–¹éƒ½éœ€è¦æ¥å—é‚€è«‹æ‰èƒ½æˆç‚ºå¥½å‹

### 3. èŠå¤©å®¤æ°¸ä¹…åŒ–
- **èˆŠç‰ˆ:** ç„¡èŠå¤©å®¤æ¦‚å¿µ
- **æ–°ç‰ˆ:** æˆç‚ºå¥½å‹å¾Œ,è‡¨æ™‚èŠå¤©å®¤è‡ªå‹•å‡ç´šç‚ºæ°¸ä¹…èŠå¤©å®¤

### 4. éæœŸæ™‚é–“
- **è‡¨æ™‚èŠå¤©å®¤:** 30 ç§’ (æ¸¬è©¦æ¨¡å¼,æ­£å¼ç’°å¢ƒç‚º 5 åˆ†é˜)
- **å¥½å‹é‚€è«‹:** 24 å°æ™‚

---

## ğŸ”§ æ¸¬è©¦å·¥å…·

### è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬
```powershell
.\test_pairing_simple.ps1
```

æ­¤è…³æœ¬æœƒè‡ªå‹•åŸ·è¡Œå®Œæ•´çš„é…å°â†’èŠå¤©â†’é‚€è«‹â†’å¥½å‹æµç¨‹ã€‚

### æ‰‹å‹•æ¸¬è©¦
åƒè€ƒ `SINGLE_DEVICE_TESTING.md` ç²å–è©³ç´°çš„æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿã€‚

---

## ğŸ“š ç›¸é—œæ–‡æª”

- **å®Œæ•´ API æ–‡æª”:** `PAIRING_CHAT_GUIDE.md`
- **å–®è£ç½®æ¸¬è©¦æŒ‡å—:** `SINGLE_DEVICE_TESTING.md`
- **åŠŸèƒ½å®Œæˆå ±å‘Š:** `CHAT_FEATURES_COMPLETION.txt`
- **å¿«é€Ÿåƒè€ƒ:** `QUICK_REFERENCE.txt`

---

## â“ å¸¸è¦‹å•é¡Œ

### Q: ç‚ºä»€éº¼èˆŠç«¯é»è¿”å› 400 éŒ¯èª¤?
A: èˆŠç«¯é»å·²è¢«æ–°çš„ pairing router å–ä»£ä¸¦è¨»é‡‹æ‰ã€‚è«‹ä½¿ç”¨æ–°ç«¯é»ã€‚

### Q: å¦‚ä½•å‰µå»ºå¥½å‹è«‹æ±‚?
A: æ–°ç‰ˆæœ¬ä¸­ç„¡éœ€æ‰‹å‹•å‰µå»ºã€‚é…å°ä¸¦èŠå¤© 30 ç§’å¾Œ,ç³»çµ±æœƒè‡ªå‹•å‰µå»ºå¥½å‹é‚€è«‹ã€‚

### Q: æˆ‘çš„å‰ç«¯ä»£ç¢¼ä½¿ç”¨èˆŠç«¯é»æ€éº¼è¾¦?
A: è«‹åƒè€ƒæœ¬æ–‡æª”çš„ç«¯é»å°æ‡‰è¡¨æ›´æ–°å‰ç«¯ä»£ç¢¼ã€‚

### Q: æ¸¬è©¦ç’°å¢ƒä¸‹ 30 ç§’å¤ªé•·æ€éº¼è¾¦?
A: å·²è¨­ç½®ç‚º 30 ç§’ (æ¸¬è©¦æ¨¡å¼)ã€‚æ­£å¼ç’°å¢ƒå»ºè­°æ”¹ç‚º 5 åˆ†é˜ã€‚

### Q: å¦‚ä½•æ”¹å› 5 åˆ†é˜?
A: ä¿®æ”¹ `backend/app/services/pairing_service.py` ç¬¬ 52 è¡Œ:
```python
expires_at = datetime.now() + timedelta(minutes=5)
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… æ›´æ–°å‰ç«¯ä»£ç¢¼ä½¿ç”¨æ–°ç«¯é»
2. â³ å¯¦ç¾ WebSocket å³æ™‚æ¨é€ (å¥½å‹é‚€è«‹é€šçŸ¥)
3. â³ å¯¦ç¾åœ¨ç·šç‹€æ…‹è¿½è¹¤
4. â³ å¯¦ç¾ç§»é™¤å¥½å‹åŠŸèƒ½
5. â³ å¯¦ç¾éš¨æ©Ÿé…å°åŠŸèƒ½

---

**æœ€å¾Œæ›´æ–°:** 2025-10-08
**ç‰ˆæœ¬:** v2.0 (æ–°é…å°èŠå¤©ç³»çµ±)
